<html>
<head>
    <title>竞价大厅</title>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
    <style>html {
        font-size: 37.5px !important;
    }

    body {
        font-size: 14.0625px
    }</style>
    <script type="text/javascript" src="/js/common/zepto1.2.0.js" replace="LIB:zepto"></script>
    <script type="text/javascript" src="/js/common/zepto-touch.js"></script>
    <script type="text/javascript" src="/js/utils.js"></script>
    <script type="text/javascript" src="/js/DateExt.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/m-base_2.0.1_reset.css">
    <link rel="stylesheet" type="text/css" href="/css/common.css">
    <link rel="stylesheet" type="text/css" href="/css/p_bid-hall_index.css">
</head>
<body>
<div id="auction-mall" class="hide">
    <div class="wrap">
        <div class="rc-toast rc-toast-out" style="left: 200%; visibility: hidden;"></div>
        <div class="loading hidden">
            <div class="km-loading">
                <div class="loading-img"></div>
            </div>
        </div>
        <div class="bid-components" data-spm="bid-hall">
            <div class="rc-statusbar ing">
                <div class="align-center">
                    <span class="status-icon pm-iconfont">时</span>
                    <span class="status-flag">正在进行</span>
                    <span class="main">
                        <div class="countdown" style="display: none;">
                            <div>00天07时02分41秒</div>
                        </div>
                        <span class="time">
                            <p><span>{{endDay}}</span> <b>{{endTime}}</b> 结束</p>
                        </span>
                        <span class="time-desc"></span>
                    </span>
                </div>
            </div>
            <div class="bid-item" style="height: 3.34375rem; opacity: 1;">
                <div class="bid-item-img"><img
                        :src="auctionPic">
                </div>
                <div class="bid-item-info">
                    <h3>{{title}}</h3>
                    <div class="bid-item-price" style="opacity: 1;">
                        <i class="desc">
                            <s class="rmb">RMB</s>
                            <s class="text">当前价</s>
                        </i>
                        <span class="price-comma">
                            <em class="price-comma-price">{{currentPrice}}</em>
                        </span>
                    </div>
                </div>
                <div class="bid-item-arrow">
                    <div class="text">
                        <i class="arrow">左</i>
                        <i>详情</i>
                    </div>
                </div>
            </div>
            <div class="bid-action">
                <div class="input-number">
                    <div class="input-number-handler-wrap">
                        <div class="input-number-handler input-number-handler-up">
                            <span class="input-number-handler-up-inner" id="add"></span>
                        </div>
                        <div class="input-number-handler input-number-handler-down" id="reduce">
                            <!--input-number-handler-down-disabled-->
                            <span class="input-number-handler-down-inner"></span>
                        </div>
                    </div>
                    <div class="input-number-input-wrap">
                        <span class="price-comma">
                            <span class="price-comma-price">
                                {{bidPrice}}
                            </span>
                        </span>
                        <div class="price-format">您将出价{{bidPrice}}元</div>
                        <input min="90100" max="Infinity" class="input-number-input" autocomplete="off" disabled=""
                               value="90100"></div>
                </div>
                <div class="bid-wrap">
                    <div class="bid bid">
                        <div class="bid-text" id="bidNow">立即出价</div>
                    </div>
                    <div class="pm-modal pm-modal-hidden" id="alert">
                        <div data-visible="false" class="pm-modal-mask"></div>
                        <div class="pm-modal-wrap" tabindex="0" role="dialog" style="margin: 0px 8.75%; width: 82.5%;">
                            <div class="pm-modal-content">
                                <div class="pm-modal-body"><p class="title">是否确认出价？</p>
                                    <p>您的出价 <span class="price-comma"><i
                                            class="price-comma-rmb">￥</i><em class="price-comma-price">{{bidPrice}}</em></span>
                                    </p></div>
                                <div class="pm-modal-footer">
                                    <button type="button" class="pm-modal-btn btn-ok-half" id="ok">确 定</button>
                                    <button type="button" class="pm-modal-btn btn-cancel-half" id="cancel">再想想</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bid-wrap">
                    <div class="pm-modal pm-modal-hidden" id="feed">
                        <div data-visible="false" class="pm-modal-mask"></div>
                        <div class="pm-modal-wrap" tabindex="0" role="dialog" style="margin: 0px 8.75%; width: 82.5%;">
                            <div class="pm-modal-content">
                                <div class="pm-modal-body">
                                    <p class="title">竞价成功</p>
                                    <p>您已竞价成功！您的出价为{{bidPrice}}元</p>
                                </div>
                                <div class="pm-modal-footer">
                                    <button type="button" class="pm-modal-btn btn-ok-half" id="ok2">确 定</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bid-wrap">
                    <div class="pm-modal pm-modal-hidden" id="proxyFeed">
                        <div data-visible="false" class="pm-modal-mask"></div>
                        <div class="pm-modal-wrap" tabindex="0" role="dialog" style="margin: 0px 8.75%; width: 82.5%;">
                            <div class="pm-modal-content">
                                <div class="pm-modal-body">
                                    <p class="title">设置代理价成功</p>
                                    <p>您已成功设置代理价！且您当前的出价为{{bidPrice}}元</p>
                                </div>
                                <div class="pm-modal-footer">
                                    <button type="button" class="pm-modal-btn btn-ok-half" id="ok4">确 定</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bid-wrap">
                    <div class="pm-modal pm-modal-hidden" id="more">
                        <div data-visible="false" class="pm-modal-mask"></div>
                        <div class="pm-modal-wrap" tabindex="0" role="dialog" style="margin: 0px 8.75%; width: 82.5%;">
                            <div class="pm-modal-content">
                                <div class="pm-modal-body">
                                    <p class="title">竞价失败</p>
                                    <p>对不起，您竞价失败！已经有人出了比您更高的价格，出价为{{currentPrice}}元</p>
                                </div>
                                <div class="pm-modal-footer">
                                    <button type="button" class="pm-modal-btn btn-ok-half" id="ok3">确 定</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bid-wrap">
                    <div class="bid bid">
                        <div class="bid-text" id="proxy">设置代理价</div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
<script src="/js/common/vue.js"></script>
<script type="application/javascript">
    var bidType = "";//auction:直接出价 proxy:设置代理价
    var bidIncrement = 0;

    $.getJSON('/goods/' + getUrlParam("goodsId"), function (response) {
        bidIncrement = response.bidIncrement;
        var endDay = Zepto().dateUtil.format(new Date(response.session.endTime), "MM月dd日");
        var endTime = Zepto().dateUtil.format(new Date(response.session.endTime), "hh:mm");
        var auctionMall = new Vue({
            el: '#auction-mall',
            data: {
                title: response.title,
                startingPrice: response.startingPrice,
                currentPrice: response.currentPrice,
                bidIncrement: response.bidIncrement,
                bidPrice: response.currentPrice + bidIncrement,
                auctionPic: response.auctionPic,
                endDay: endDay,
                endTime: endTime
            }
        });
        window.auctionMall = auctionMall;

        addTap();
        Zepto("#auction-mall").removeClass("hide");
    });

    function addTap() {
        Zepto("#add").tap(function (event) {
            //prevent same event from firing twice
            if (isJqmGhostClick(event)) {
                return;
            }
            auctionMall.bidPrice += bidIncrement;
        });

        Zepto("#reduce").tap(function (event) {
            //prevent same event from firing twice
            if (isJqmGhostClick(event)) {
                return;
            }
            if (auctionMall.bidPrice - bidIncrement > auctionMall.currentPrice) {
                auctionMall.bidPrice -= bidIncrement;
            }
        });

        Zepto("#bidNow").tap(function (event) {
            //prevent same event from firing twice
            if (isJqmGhostClick(event)) {
                return;
            }
            bidType = "auction";
            Zepto("#alert").removeClass("pm-modal-hidden");
        });

        Zepto("#proxy").tap(function (event) {
            //prevent same event from firing twice
            if (isJqmGhostClick(event)) {
                return;
            }
            bidType = "proxy";
            Zepto("#alert").removeClass("pm-modal-hidden");
        });

        Zepto("#cancel").tap(function (event) {
            //prevent same event from firing twice
            if (isJqmGhostClick(event)) {
                return;
            }
            Zepto("#alert").addClass("pm-modal-hidden");
        });

        //提交到服务端
        Zepto("#ok").tap(function (event) {
            //prevent same event from firing twice
            if (isJqmGhostClick(event)) {
                return;
            }
            if ("auction" == bidType) {
                $.ajax({
                    type: 'POST',
                    url: '/auction/goods/' + getUrlParam("goodsId") + "/price/" + auctionMall.bidPrice,
                    data: JSON.stringify({price: auctionMall.bidPrice}),
                    contentType: 'application/json',
                    success: function (response) {
                        Zepto("#alert").addClass("pm-modal-hidden");
                        if (response && 0 == response.code) {
                            auctionMall.currentPrice = auctionMall.bidPrice;
                            Zepto("#feed").removeClass("pm-modal-hidden");
                        } else if (response && -1 == response.code) {
                            auctionMall.currentPrice = response.price;
                            auctionMall.bidPrice = auctionMall.currentPrice + bidIncrement;
                            Zepto("#more").removeClass("pm-modal-hidden");
                        }
                    }
                });
            } else if ("proxy" == bidType) {
                $.ajax({
                    type: 'POST',
                    url: '/proxyAuction/goods/' + getUrlParam("goodsId") + "/price/" + auctionMall.bidPrice,
                    data: JSON.stringify({price: auctionMall.bidPrice}),
                    contentType: 'application/json',
                    success: function (response) {
                        Zepto("#alert").addClass("pm-modal-hidden");
                        if (response && 0 == response.code) {
                            auctionMall.currentPrice = auctionMall.currentPrice + bidIncrement;
                            auctionMall.bidPrice = auctionMall.currentPrice;
                            Zepto("#proxyFeed").removeClass("pm-modal-hidden");
                        } else if (response && -1 == response.code) {
                            auctionMall.currentPrice = response.price;
                            auctionMall.bidPrice = auctionMall.currentPrice + bidIncrement;
                            Zepto("#more").removeClass("pm-modal-hidden");
                        }
                    }
                });
            }

        });

        Zepto("#ok2").tap(function (event) {
            //prevent same event from firing twice
            if (isJqmGhostClick(event)) {
                return;
            }
            auctionMall.bidPrice += bidIncrement;
            Zepto("#feed").addClass("pm-modal-hidden");
        });

        Zepto("#ok3").tap(function (event) {
            //prevent same event from firing twice
            if (isJqmGhostClick(event)) {
                return;
            }
            Zepto("#more").addClass("pm-modal-hidden");
        });

        Zepto("#ok4").tap(function (event) {
            //prevent same event from firing twice
            if (isJqmGhostClick(event)) {
                return;
            }
            auctionMall.bidPrice = auctionMall.bidPrice + bidIncrement;
            Zepto("#proxyFeed").addClass("pm-modal-hidden");
        });
    }

    var lastTapTime;
    function isJqmGhostClick(event) {
        var time_threshold = 10;
        var currTapTime = new Date().getTime();

        if (lastTapTime == null || currTapTime > (lastTapTime + time_threshold)) {
            lastTapTime = currTapTime;
            return false;
        }
        else {
            return true;
        }
    }

    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
        var r = window.location.search.substr(1).match(reg);  //匹配目标参数
        if (r != null) return unescape(r[2]);
        return null; //返回参数值
    }
</script>
<script type="application/javascript">

</script>
</body>
</html>